<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="daizutabi">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <title>Ivory Core Entities &mdash; Ivory</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <link rel="stylesheet" href="../../css/mkapi.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css">
    <link rel="stylesheet" href="../../css/pheasant.css">
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script> 
</head>

<body ontouchstart="">
    <div id="container">
        <aside>
            <div class="home">
                <div class="title">
                    <button class="hamburger"></button>
                    <a href="../.." class="site-name"> Ivory</a>
                </div><div class="version">0.2.1</div>
                <div class="search">
                    <div role="search">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
        <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
    </form>
</div>
                </div>
            </div>
            <nav class="nav">
                <ul class="root">
                    <li class="toctree-l1"><a class="nav-item" href="../..">Ivory Documentation</a></li>
                    <li class="toctree-l1"><a class="nav-item" href="../../quickstart/">Quickstart</a></li>
                    <li class="toctree-l1"><button class="section nav-item">Tutorial</button>
<ul class="subnav">
    <li class="toctree-l2"><a class="nav-item" href="../data/">Set of Data classes</a></li>
    <li class="toctree-l2"><a class="nav-item" href="../instance/">Creating Instance</a></li>
    <li class="toctree-l2"><a class="nav-item" href="../model/">Model Structure</a></li>
    <li class="toctree-l2"><a class="nav-item" href="../callbacks/">Callbacks</a></li>
    <li class="toctree-l2"><a class="nav-item" href="../trainer/">Training a Model</a></li>
    <li class="toctree-l2 current"><a class="nav-item current" href="./">Ivory Core Entities</a>
<ul class="subnav">
<li class="toctree-l3"><a class="nav-item toc" href="#client">Client</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#experiment">Experiment</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#run">Run</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#task-for-multiple-runs">Task for multiple runs</a></li>
</ul></li>
    <li class="toctree-l2"><a class="nav-item" href="../task/">Multiple Runs</a></li>
</ul></li>
                </ul>
            </nav>
            <div class="repo">
    <div class="link">
        <a href="https://github.com/daizutabi/ivory/" class="fa fa-github"> GitHub</a>
    </div>
    <div class="previous"><a href="../trainer/">&laquo; Previous</a></div>
    <div class="next"><a href="../task/">Next &raquo;</a></div>
</div>
        </aside>
        <div id="spacer"><button class="arrow"></button></div>
        <main>
            <div class="home-top">
                <button class="hamburger"></button>
                <a href="../.." class="site-name"> Ivory</a>
            </div>
            <div id="main">
                <nav class="breadcrumbs">
<ul>
    <li>Tutorial</li>
</ul>
</nav>
                <div id="content">
<h1 id="ivory-core-entities"><span class="pheasant-header"><span class="header"><span class="title">Ivory Core Entities</span></span></span></h1>
<h2 id="client"><span class="pheasant-header"><span class="header"><span class="title">Client</span></span></span></h2>
<p>Ivory has the <code>Client</code> class that manages the workflow of machine learning. In this tutorial, we are working with data and model to predict rectangle area. The source module exists under the <code>examples</code> directory.</p>
<p>First, create a <code>Client</code> instance.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">import ivory

client = ivory.create_client(&#34;examples&#34;)  # Set the working directory
client</code></pre></div>
<div class="report"><p><span class="count">[2]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">482ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.62s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Client(num_objects=2)</code></pre></div></div></div>

<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">list(client)</code></pre></div>
<div class="report"><p><span class="count">[3]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">3.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.62s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">[&#39;tracker&#39;, &#39;tuner&#39;]</code></pre></div></div></div>

<p>The first object is a <code>Tracker</code> instance which connects Ivory to <a href="https://mlflow.org/docs/latest/tracking.html">MLFlow Tracking</a>.</p>
<p>The second objects is named <code>tuner</code>. A <code>Tuner</code> instance connects Ivory to <a href="https://preferred.jp/en/projects/optuna/">Optuna: A hyperparameter optimization framework</a>.</p>
<p>Show the files in the working directory <code>examples</code>.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">import os

os.listdir(&#39;examples&#39;)</code></pre></div>
<div class="report"><p><span class="count">[4]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.63s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">[&#39;client.yml&#39;, &#39;mlruns&#39;, &#39;rectangle&#39;, &#39;torch.yml&#39;, &#39;__pycache__&#39;]</code></pre></div></div></div>

<p><code>rectangle</code> is a Python package that contains our examples. YAML files with extension of <code>.yml</code> or possibly <code>.yaml</code> are parameter files to define a machine learning workflow. Basically, one YAML file is corresponding to one <code>Experiment</code> as discussed later, except the <code>client.yml</code> file. A YAML file name without the extension becomes an experiment name. <code>mlruns</code> is a directory automatically created by the MLFlow Tracking in which our trained model and callbacks instances are saved.</p>
<p>The <code>client.yml</code> is a configuration file for a <code>Client</code> instance. In our case, the file just contains the minimum settings.</p>
<div class="pheasant-header"><div class="other"><p class="caption"><span class="prefix">File</span> <span class="number">5</span>
<span class="title">client.yml</span></p>
<div class="content"><p style="font-color:red">File not found: C:\Users\daizu\Documents\github\ivory\docs\tutorial\examples\client.yml</p>
</div></div></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A YAML file for client is not required. If there is no file for client, Ivory creates a default client with a tracker and without a tuner.</p>
<p>If you don't need a tracker, for example in debugging, use <code>ivory.create_client(tracker=False)</code>.</p>
</div>
<h2 id="experiment"><span class="pheasant-header"><span class="header"><span class="title">Experiment</span></span></span></h2>
<p>The <code>Client.create_experiment()</code> function creates an <code>Experiment</code> instance. If the <code>Client</code> instance has a <code>tracker</code>, an experiment of the MLFlow Tracking is also created at the same time if it hasn't existed yet. By cliking an icon (<i class="far fa-eye-slash" style="font-size:0.8rem; color: #ff8888;"></i>) in the below cell, you can see the log.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">experiment = client.create_experiment(&#39;torch&#39;)  # Read torch.yml as params.
experiment</code></pre></div>
<div class="report"><p><span class="count">[5]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">14.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.64s</span>)</span></p></div></div><div class="cell jupyter stderr"><div class="code">
      <pre><code class="nohighlight">[I 200527 11:20:16 tracker:48] A new experiment created with name: &#39;torch&#39;</code></pre></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Experiment(id=&#39;1&#39;, name=&#39;torch&#39;, num_objects=1)</code></pre></div></div></div>

<p>The ID for this experiment was given by the MLFlow Tracking. The <code>Client.create_experiment()</code> function loads a corresponding YAML file to the first argument from the working directory.</p>
<div class="pheasant-header"><div class="other"><p class="caption"><span class="prefix">File</span> <span class="number">6</span>
<span class="title">torch.yml</span></p>
<div class="content"><p style="font-color:red">File not found: C:\Users\daizu\Documents\github\ivory\docs\tutorial\examples\torch.yml</p>
</div></div></div>

<p>After loading, the <code>Experiment</code> instance setups the parameters for creating runs later. The parameters are stored in the <code>params</code> attribute.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">experiment.params</code></pre></div>
<div class="report"><p><span class="count">[6]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">5.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.64s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">{&#39;run&#39;: {&#39;dataloaders&#39;: {&#39;data&#39;: {&#39;class&#39;: &#39;rectangle.data.Data&#39;,
    &#39;n_splits&#39;: 4},
   &#39;dataset&#39;: {&#39;def&#39;: &#39;ivory.torch.data.Dataset&#39;},
   &#39;batch_size&#39;: 10,
   &#39;fold&#39;: 0,
   &#39;class&#39;: &#39;ivory.torch.data.DataLoaders&#39;},
  &#39;model&#39;: {&#39;class&#39;: &#39;rectangle.torch.Model&#39;, &#39;hidden_sizes&#39;: [100, 100]},
  &#39;optimizer&#39;: {&#39;class&#39;: &#39;torch.optim.SGD&#39;,
   &#39;params&#39;: &#39;$.model.parameters()&#39;,
   &#39;lr&#39;: 0.001},
  &#39;scheduler&#39;: {&#39;class&#39;: &#39;torch.optim.lr_scheduler.ReduceLROnPlateau&#39;,
   &#39;optimizer&#39;: &#39;$&#39;,
   &#39;factor&#39;: 0.5,
   &#39;patience&#39;: 4},
  &#39;results&#39;: {&#39;class&#39;: &#39;ivory.torch.results.Results&#39;},
  &#39;metrics&#39;: {&#39;criterion&#39;: {&#39;def&#39;: &#39;torch.nn.functional.mse_loss&#39;},
   &#39;class&#39;: &#39;ivory.torch.metrics.Metrics&#39;},
  &#39;monitor&#39;: {&#39;metric&#39;: &#39;val_loss&#39;,
   &#39;class&#39;: &#39;ivory.callbacks.monitor.Monitor&#39;},
  &#39;early_stopping&#39;: {&#39;patience&#39;: 10,
   &#39;class&#39;: &#39;ivory.callbacks.early_stopping.EarlyStopping&#39;},
  &#39;trainer&#39;: {&#39;epochs&#39;: 10,
   &#39;verbose&#39;: 2,
   &#39;class&#39;: &#39;ivory.torch.trainer.Trainer&#39;},
  &#39;class&#39;: &#39;ivory.torch.run.Run&#39;},
 &#39;experiment&#39;: {&#39;name&#39;: &#39;torch&#39;,
  &#39;class&#39;: &#39;ivory.core.base.Experiment&#39;,
  &#39;id&#39;: &#39;1&#39;}}</code></pre></div></div></div>

<p>This is similar to the YAML file, but is slightly changed by the Ivory Client.</p>
<ul>
<li>Run and experiment sections are inserted.</li>
<li>ExperimentID and RunID are assigned by the MLFlow Tracking.</li>
<li>Default classes are specified, for example <code>ivory.torch.trainer.Trainer</code> for a trainer instance.</li>
</ul>
<h2 id="run"><span class="pheasant-header"><span class="header"><span class="title">Run</span></span></span></h2>
<p>After setting up an <code>Experiment</code> instance, you can create runs with various parameter.</p>
<p><strong>Default parameters</strong></p>
<p>Calling without arguments creates a run with default parameters.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run()
run</code></pre></div>
<div class="report"><p><span class="count">[7]</span>
<span class="start">2020-05-27 11:20:16</span> (<span class="time">264ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.91s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Run(id=&#39;26fa789e22d84976a233310b51302a9c&#39;, name=&#39;run#0&#39;, num_objects=12)</code></pre></div></div></div>

<p>Here, the ID for this run was given by the MLFlow Tracking. On the other hand, the name is given by Ivory as a form of "<code>(run class name in lower case)#(run number)</code>".</p>
<p><strong>Parameter configuration</strong></p>
<p>Passing key-value pairs, you can change the parameters.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run(fold=1)
run.dataloaders.fold</code></pre></div>
<div class="report"><p><span class="count">[8]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">41.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">2.95s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">1</code></pre></div></div></div>

<p>But the type of parameter must be equal, otherwise a <code>ValueError</code> is raised.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run(fold=0.5)
run.dataloaders.fold</code></pre></div>
<div class="report"><p><span class="count">[9]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">129ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.08s</span>)</span></p></div></div><div class="cell jupyter error"><div class="code"><pre><code class="nohighlight">ValueError: different type: &lt;class &#39;int&#39;&gt; != &lt;class &#39;float&#39;&gt;</code></pre></div>
      <div class="report"><pre><code class="nohighlight">ValueError                                Traceback (most recent call last)
&lt;ipython-input-98-689904ca4a89&gt; in &lt;module&gt;
----&gt; 1 run = experiment.create_run(fold=0.5)
      2 run.dataloaders.fold

~\Documents\github\ivory\ivory\core\base.py in create_run(self, args, name, **kwargs)
     55 
     56     def create_run(self, args=None, name: str = &#34;run&#34;, **kwargs):
---&gt; 57         params, args = self.create_params(args, name, **kwargs)
     58         run = instance.create_base_instance(params, name, self.source_name)
     59         if self.tracker:

~\Documents\github\ivory\ivory\core\base.py in create_params(self, args, name, **kwargs)
     51             params.update(default.get(name))
     52         update, args = utils.params.create_update(params[name], args, **kwargs)
---&gt; 53         utils.params.update_dict(params[name], update)
     54         return params, args
     55 

~\Documents\github\ivory\ivory\utils\params.py in update_dict(org, update)
     28             x[k] = value
     29         elif type(x[k]) is not type(value) and x[k] is not None:
---&gt; 30             raise ValueError(f&#34;different type: {type(x[k])} != {type(value)}&#34;)
     31         else:
     32             if isinstance(x[k], dict):</code></pre></div></div></div>

<p><strong>Duplicated parameter</strong></p>
<p>Duplicated parameters are updated together.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run(patience=5)
run.scheduler.patience, run.early_stopping.patience</code></pre></div>
<div class="report"><p><span class="count">[10]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">136ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.21s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">(5, 5)</code></pre></div></div></div>

<p><strong>Scoping by dots</strong></p>
<p>To specify an individual parameter, use scoping by dots. In this case, pass a dictionary with string type keys with dots to the first argument.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">update = {&#39;scheduler.patience&#39;: 8, &#39;early_stopping.patience&#39;: 20}
run = experiment.create_run(update)
run.scheduler.patience, run.early_stopping.patience</code></pre></div>
<div class="report"><p><span class="count">[11]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">42.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.26s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">(8, 20)</code></pre></div></div></div>

<p><strong>Object type</strong></p>
<p>Parameters are not limited to a literal such as <code>int</code>, <code>float</code>, or <code>str</code>. For example,</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run()
run.optimizer</code></pre></div>
<div class="report"><p><span class="count">[12]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">42.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.30s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">SGD (
Parameter Group 0
    dampening: 0
    lr: 0.001
    momentum: 0
    nesterov: False
    weight_decay: 0
)</code></pre></div></div></div>

<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">run = experiment.create_run({&#39;optimizer.class&#39;: &#39;torch.optim.Adam&#39;})
run.optimizer</code></pre></div>
<div class="report"><p><span class="count">[13]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">46.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.34s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Adam (
Parameter Group 0
    amsgrad: False
    betas: (0.9, 0.999)
    eps: 1e-08
    lr: 0.001
    weight_decay: 0
)</code></pre></div></div></div>

<p>This means that you can compare optimizer algorithms easily through multiple runs with minimul effort.</p>
<p>In the previous examples, we created runs using the <code>experiment.create_run()</code> method. In addtion, you can do the same thing by <code>client.create_run()</code> with an experiment name as the first argument. The following code blocks are qeuivalent.</p>
<div class="pheasant-header"><div class="other"><p class="caption"><span class="prefix">Code</span> <span class="number">4</span>
</p>
<div class="content">
<div class="pheasant-fenced-code"><div class="cell embed source"><div class="code"><pre><code class="python">experiment = client.create_experiment(&#39;torch&#39;)
run = experiment.create_run(fold=3)</code></pre></div></div></div>

</div></div></div>

<div class="pheasant-header"><div class="other"><p class="caption"><span class="prefix">Code</span> <span class="number">5</span>
</p>
<div class="content">
<div class="pheasant-fenced-code"><div class="cell embed source"><div class="code"><pre><code class="python">run = client.create_run(&#39;torch&#39;, fold=3)</code></pre></div></div></div>

</div></div></div>

<h2 id="task-for-multiple-runs"><span class="pheasant-header"><span class="header"><span class="title">Task for multiple runs</span></span></span></h2>
<p>Ivory implements a special run type called <strong>Task</strong> which controls multiple nested runs. A task is useful for parameter search or cross validation.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python"># task = experiment.create_task()  #  Alternative method.
task = client.create_task(&#39;torch&#39;)
task</code></pre></div>
<div class="report"><p><span class="count">[14]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">50.0ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.39s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Task(id=&#39;6a6334fe50ea488588518418986f83ea&#39;, name=&#39;task#0&#39;, num_objects=3)</code></pre></div></div></div>

<p>The <code>Task</code> class has two methods to generate multiple runs: <code>prodcut()</code> and <code>chain()</code>. These two methods have the same functionality as <a href="https://docs.python.org/3/library/itertools.html"><code>itertools</code></a> of Python starndard library.</p>
<div class="pheasant-fenced-code"><div class="cell jupyter input"><div class="code"><pre><code class="python">runs = task.product(fold=range(2), lr=[1e-4, 1e-3])
runs</code></pre></div>
<div class="report"><p><span class="count">[15]</span>
<span class="start">2020-05-27 11:20:17</span> (<span class="time">3.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">3.40s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">&lt;generator object Task.product at 0x0000012E5FBE94C8&gt;</code></pre></div></div></div></div>
                <footer>
    <div class="footer-buttons">
        <div class="previous"><a href="../trainer/" title="Training a Model"><span>Previous</span></a></div>
        <div class="next"><a href="../task/" title="Multiple Runs"><span>Next</span></a></div>
    </div>
    <div class="footer-note">
        <p>
            Built with <a href="http://www.mkdocs.org">MkDocs</a> using
            <a href="https://github.com/daizutabi/mkdocs-ivory">Ivory theme</a>.
        </p>
    </div>
</footer>
            </div>
        </main>
    </div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
    <script src="../../js/mkapi.js"></script>
    <script src="../../js/pheasant.js"></script>
    <script src="../../search/main.js"></script>
</body>

</html>