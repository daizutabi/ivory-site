<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="daizutabi">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <title>Data &mdash; Ivory</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css">
    <link rel="stylesheet" href="../../css/pheasant.css">
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script> 
</head>

<body ontouchstart="">
    <div id="container">
        <aside>
            <div class="home">
                <div class="title">
                    <button class="hamburger"></button>
                    <a href="../.." class="site-name"> Ivory</a>
                </div><div class="version">0.1.2</div>
                <div class="search">
                    <div role="search">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
        <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
    </form>
</div>
                </div>
            </div>
            <nav class="nav">
                <ul class="root">
                    <li class="toctree-l1"><a class="nav-item" href="../..">Ivory</a></li>
                    <li class="toctree-l1"><button class="section nav-item">Tutorial</button>
<ul class="subnav">
    <li class="toctree-l2"><a class="nav-item" href="../experiment/">Experiment</a></li>
    <li class="toctree-l2 current"><a class="nav-item current" href="./">Data</a>
<ul class="subnav">
<li class="toctree-l3"><a class="nav-item toc" href="#create-data">Create data</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#dataset">Dataset</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#dataloaders">DataLoaders</a></li>
<li class="toctree-l3"><a class="nav-item toc" href="#dataloaders_1">DataLoaders</a></li>
</ul></li>
</ul></li>
                </ul>
            </nav>
            <div class="repo">
    <div class="link">
        <a href="https://github.com/daizutabi/ivory/" class="fa fa-github"> GitHub</a>
    </div>
    <div class="previous"><a href="../experiment/">&laquo; Previous</a></div>
</div>
        </aside>
        <div id="spacer"><button class="arrow"></button></div>
        <main>
            <div class="home-top">
                <button class="hamburger"></button>
                <a href="../.." class="site-name"> Ivory</a>
            </div>
            <div id="main">
                <nav class="breadcrumbs">
<ul>
    <li>Tutorial</li>
</ul>
</nav>
                <div id="content">
<h1 id="data"><span class="pheasant-header"><span class="header"><span class="title">Data</span></span></span></h1>
<h2 id="create-data"><span class="pheasant-header"><span class="header"><span class="title">Create data</span></span></span></h2>
<p>As a simple toy example, we try to predict <code>area</code> of rectangles which have <code>width</code> and <code>height</code>, but they include some noises.</p>
<p>First, define a function to create such data.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">import numpy as np
import pandas as pd

import ivory
from ivory.utils import kfold_split

def create_data(num_samples=1000):
    &#34;&#34;&#34;Returns a tuple of (input, target). Target has fold information.&#34;&#34;&#34;
    x = 4 * np.random.rand(num_samples, 2) + 1
    x = x.astype(np.float32)
    noises = 0.1 * (np.random.rand(2, num_samples) - 0.5)
    df = pd.DataFrame(x, columns=[&#34;width&#34;, &#34;height&#34;])
    df[&#34;area&#34;] = (df.width + noises[0]) * (df.height + noises[1])
    df.area = df.area.astype(np.float32)
    df[&#34;fold&#34;] = kfold_split(df.index, n_splits=5)
    return df[[&#34;width&#34;, &#34;height&#34;]], df[[&#34;fold&#34;, &#34;area&#34;]]</code></pre></div>
<div class="report"><p><span class="count">[1]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">6.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.81s</span>)</span></p></div></div></div></div>

<p><code>kfold_split</code> function creates a fold-array.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">kfold_split(np.arange(10), n_splits=3)</code></pre></div>
<div class="report"><p><span class="count">[2]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">5.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.82s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">array([2, 1, 0, 2, 0, 2, 1, 1, 0, 0], dtype=int8)</code></pre></div></div></div></div>

<p>To execute <code>create_data</code> funtion, you can use a dictionary as well as a YAML file.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">params = {&#39;data&#39;: {&#39;def&#39;: &#39;create_data&#39;}}</code></pre></div>
<div class="report"><p><span class="count">[3]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">3.01ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.82s</span>)</span></p></div></div></div></div>

<p>The key of <code>def</code> means that the value is a funtion instead of a class. Apply this dictionary to <code>ivory.instantiate</code> function to get an instantiated object dictionary.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">data = ivory.instantiate(params)[&#39;data&#39;]
data[0].head()</code></pre></div>
<div class="report"><p><span class="count">[4]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">9.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.83s</span>)</span></p></div></div>

<div class="cell jupyter display"><div class="content"><table class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>width</th>
      <th>height</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2.721977</td>
      <td>2.108382</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.904444</td>
      <td>2.768574</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.438495</td>
      <td>4.878826</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.680521</td>
      <td>2.841346</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.493506</td>
      <td>4.525074</td>
    </tr>
  </tbody>
</table></div></div></div></div>

<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">data[1].head()</code></pre></div>
<div class="report"><p><span class="count">[5]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">5.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.84s</span>)</span></p></div></div>

<div class="cell jupyter display"><div class="content"><table class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>fold</th>
      <th>area</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>5.675824</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>10.749290</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>7.138609</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>10.390873</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>15.907549</td>
    </tr>
  </tbody>
</table></div></div></div></div>

<p>You can change the data size with additional key-value pairs (in this case, the minimun size is the number of fold 5).</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">params = {&#39;data&#39;: {&#39;def&#39;: &#39;create_data&#39;, &#39;num_samples&#39;: 5}}
ivory.instantiate(params)[&#39;data&#39;][1]</code></pre></div>
<div class="report"><p><span class="count">[6]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">8.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.84s</span>)</span></p></div></div>

<div class="cell jupyter display"><div class="content"><table class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>fold</th>
      <th>area</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>3.548383</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>6.152096</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>5.675569</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>21.535194</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5.301344</td>
    </tr>
  </tbody>
</table></div></div></div></div>

<h2 id="dataset"><span class="pheasant-header"><span class="header"><span class="title">Dataset</span></span></span></h2>
<p>Ivory provides <code>ivory.torch.Dataset</code> for PyTorch.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">from ivory.torch import Dataset

dataset = Dataset(data[0], data[1])
dataset</code></pre></div>
<div class="report"><p><span class="count">[7]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">5.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.85s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Dataset(num_samples=1000, input_shape=(2,), target_shape=(2,), mode=&#39;train&#39;)</code></pre></div></div></div></div>

<p>Ivory's <code>Dataset</code> is a subclass of PyTorch's <code>Dataset</code></p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">import torch.utils.data

isinstance(dataset, torch.utils.data.Dataset)</code></pre></div>
<div class="report"><p><span class="count">[8]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.85s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">True</code></pre></div></div></div></div>

<p>Check an item.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">dataset[0]</code></pre></div>
<div class="report"><p><span class="count">[9]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.86s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">(0,
 array([2.7219775, 2.1083822], dtype=float32),
 array([2.       , 5.6758237], dtype=float32))</code></pre></div></div></div></div>

<p>Indexing returns a tuple. The first is an index, the second is an input, and the last is a target. The target includes fold which is not a real target. But, it's okay because we don't use a <code>Dataset</code> directly. We can use more usefull <code>DataLoaders</code> provided by Ivory.</p>
<h2 id="dataloaders"><span class="pheasant-header"><span class="header"><span class="title">DataLoaders</span></span></span></h2>
<p><code>DataLoaders</code> provides a data loader for both training and validation. This is the reason why our data include fold information.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">from ivory.torch import DataLoaders

dataloaders = DataLoaders(data[0], data[1], batch_size=3)
dataloaders</code></pre></div>
<div class="report"><p><span class="count">[10]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.86s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">DataLoaders(num_folds=5, num_samples=1000, input_shape=(2,), target_shape=(1,))</code></pre></div></div></div></div>

<p><code>DataLoaders</code> instance can detect the number of fold and remove the fold information from the target. Normal indexing can be used to get a pair of train data loader and validation data loader.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">train_loader, val_loader = dataloaders[0]</code></pre></div>
<div class="report"><p><span class="count">[11]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.87s</span>)</span></p></div></div></div></div>

<p>Here, index means fold number, in this case, ranging from 0 to 4 because the number of K-fold is 5. Check the data loarder.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">train_loader</code></pre></div>
<div class="report"><p><span class="count">[12]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">3.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.87s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">&lt;torch.utils.data.dataloader.DataLoader at 0x249f06937c8&gt;</code></pre></div></div></div></div>

<p>The data loader is a pure PyTorch's <code>DataLoader</code>. Let's see the dataset that the data loader has.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">train_loader.dataset</code></pre></div>
<div class="report"><p><span class="count">[13]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">3.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.87s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Dataset(num_samples=800, input_shape=(2,), target_shape=(1,), mode=&#39;train&#39;)</code></pre></div></div></div></div>

<p>This is our Ivory's dataset. The number of samples reduces from 1000 to 800 because we uses 5 folds (80% reduction). Validation dataset shoud have the rest 20% samples.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">val_loader.dataset</code></pre></div>
<div class="report"><p><span class="count">[14]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.88s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">Dataset(num_samples=200, input_shape=(2,), target_shape=(1,), mode=&#39;val&#39;)</code></pre></div></div></div></div>

<p>Now check iteration.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">it = iter(train_loader)
next(it)</code></pre></div>
<div class="report"><p><span class="count">[15]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">8.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.88s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">[tensor([ 84, 393, 338]),
 tensor([[3.2827, 1.2530],
         [2.2827, 2.7727],
         [4.4101, 3.5365]]),
 tensor([[ 4.1268],
         [ 6.4488],
         [15.4162]])]</code></pre></div></div></div></div>

<p><code>next()</code> returns a list of <code>torch.Tensor</code>. The first is an index, the second is an input, and the last is a target. Note that the target doesn't include fold any more. In default setting, train data loader shuffles its data. Validation data loader doesn't:</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="python">it = iter(val_loader)
next(it)</code></pre></div>
<div class="report"><p><span class="count">[16]</span>
<span class="start">2020-03-12 01:59:09</span> (<span class="time">4.00ms</span>)
<span class="right"><span class="kernel">python3</span> (<span class="total">1.89s</span>)</span></p></div></div><div class="cell jupyter output"><div class="code"><pre><code class="nohighlight">[tensor([1, 5, 8]),
 tensor([[3.9044, 2.7686],
         [3.0229, 4.9662],
         [3.1588, 2.9484]]),
 tensor([[10.7493],
         [14.9745],
         [ 9.4358]])]</code></pre></div></div></div></div>

<h2 id="dataloaders_1"><span class="pheasant-header"><span class="header"><span class="title">DataLoaders</span></span></span></h2></div>
                <footer>
    <div class="footer-buttons">
        <div class="previous"><a href="../experiment/" title="Experiment"><span>Previous</span></a></div>
    </div>
    <div class="footer-note">
        <p>
            Built with <a href="http://www.mkdocs.org">MkDocs</a> using
            <a href="https://github.com/daizutabi/mkdocs-ivory">Ivory theme</a>.
        </p>
    </div>
</footer>
            </div>
        </main>
    </div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
    <script src="../../js/pheasant.js"></script>
    <script src="../../search/main.js"></script>
</body>

</html>